{
  "nodes": [
    {
      "name": "DailyTrigger",
      "type": "trigger",
      "subtype": "schedule",
      "position": [100, 200],
      "parameters": {
        "mode": {
          "mode": "daily",
          "dailyTime": "12:00:00"
        },
        "timezone": "Asia/Ho_Chi_Minh"
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "timestamp": { "type": "string" },
          "nextRunTime": { "type": "string" },
          "runCount": { "type": "number" }
        }
      }
    },
    {
      "name": "ExcelReader",
      "type": "data-transform",
      "subtype": "function",
      "position": [300, 200],
      "parameters": {
        "language": "javascript",
        "code": "readBatchNewFeedbacks()"
      },
      "outputSchema": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "image": { "type": "string" },
            "comment": { "type": "string" },
            "client_email": { "type": "string" },
            "date": { "type": "string" }
          },
          "required": ["image", "comment", "email", "date"]
        }
      }
    },
    {
      "name": "SplitInBatches",
      "type": "data-transform",
      "subtype": "split",
      "position": [500, 200],
      "parameters": {
        "batchSize": 1
      },
      "inputSchema": {
        "items": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "image": { "type": "string" },
              "comment": { "type": "string" },
              "client_email": { "type": "string" },
              "date": { "type": "string" }
            }
          }
        }
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "image": { "type": "string" },
          "comment": { "type": "string" },
          "client_email": { "type": "string" },
          "date": { "type": "string" }
        }
      }
    },
    {
      "name": "NaverImageAnalyze",
      "type": "ai-processing",
      "subtype": "image-analyze",
      "position": [700, 120],
      "parameters": {
        "prompt": "Point out team is responsible for this product type, {{teams_data}}, {{json.image}}. If no team is responsible, return 'Others'.",
        "url": "https://naver.ai/image/analyze",
        "method": "POST"
      },
      "inputSchema": {
        "type": "object",
        "properties": {
          "image": { "type": "string" }
        }
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "type": { "type": "string" },
          "item": { "type": "string" },
          "description": { "type": "string" },
          "team": { "type": "string" },
          "team_email": { "type": "string" }
        }
      }
    },
    {
      "name": "NaverTextAnalyze",
      "type": "ai-processing",
      "subtype": "text-analyze",
      "position": [700, 280],
      "parameters": {
        "prompt": "Analyze this user's feedback and return the problem and solution. {{json.comment}}",
        "url": "https://naver.ai/chat/analyze",
        "method": "POST"
      },
      "inputSchema": {
        "type": "object",
        "properties": {
          "comment": { "type": "string" }
        }
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "problem": { "type": "string" },
          "solution": { "type": "string" }
        }
      }
    },
    {
      "name": "CheckTeamCondition",
      "type": "control",
      "subtype": "if",
      "position": [900, 120],
      "parameters": {
        "field": "{{json.team}}",
        "operator": "==",
        "value": "Others",
        "trueNodeName": "End Node",
        "falseNodeName": "MergeData"
      },
      "inputSchema": {
        "type": "object",
        "properties": {
          "type": { "type": "string" },
          "item": { "type": "string" },
          "description": { "type": "string" },
          "team": { "type": "string" },
          "team_email": { "type": "string" }
        }
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "type": { "type": "string" },
          "item": { "type": "string" },
          "description": { "type": "string" },
          "team": { "type": "string" },
          "team_email": { "type": "string" }
        }
      }
    },
    {
      "name": "Merge Data",
      "type": "data-transform",
      "subtype": "function",
      "position": [1000, 200],
      "parameters": {},
      "inputSchema": {
        "type": { "type": "object" },
        "properties": {
          "brand-1": {
            "type": "object",
            "properties": {
              "type": { "type": "string" },
              "item": { "type": "string" },
              "description": { "type": "string" },
              "team": { "type": "string" },
              "team_email": { "type": "string" }
            }
          },
          "brand-2": {
            "type": "object",
            "properties": {
              "problem": { "type": "string" },
              "solution": { "type": "string" }
            }
          },
          "brand-3": {
            "type": "object",
            "properties": {
              "date": { "type": "string" },
              "client_email": { "type": "string" }
            }
          }
        }
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "type": { "type": "string" },
          "item": { "type": "string" },
          "description": { "type": "string" },
          "team": { "type": "string" },
          "team_email": { "type": "string" },
          "problem": { "type": "string" },
          "solution": { "type": "string" },
          "client_email": { "type": "string" },
          "date": { "type": "string" }
        }
      }
    },
    {
      "name": "SaveToDB",
      "type": "output",
      "subtype": "database_write",
      "position": [1100, 200],
      "parameters": {
        "database": { "type": "string" },
        "table": { "type": "string" },
        "fields": {
          "image": { "type": "string" },
          "problem": { "type": "string" },
          "team": { "type": "string" },
          "date": { "type": "string" },
          "client_email": { "type": "string" }
        },
        "credentials": {
          "type": "object",
          "properties": {
            "API_KEY": { "type": "string" },
            "API_SECRET": { "type": "string" }
          }
        }
      },
      "inputSchema": {
        "type": "object",
        "properties": {
          "image": { "type": "string" },
          "problem": { "type": "string" },
          "team": { "type": "string" },
          "date": { "type": "string" },
          "client_email": { "type": "string" }
        }
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "status": { "type": "string" }
        }
      }
    },
    {
      "name": "TeamEMail",
      "type": "output",
      "subtype": "mail-writer",
      "position": [1300, 200],
      "parameters": {
        "to": "{{json.team_email}}",
        "subject": "User's feedback {{json.item}}",
        "body": { "type": "string" }
      },
      "inputSchema": {
        "type": "object",
        "properties": {
          "image": { "type": "string" },
          "item": { "type": "string" },
          "problem": { "type": "string" },
          "solution": { "type": "string" },
          "date": { "type": "string" },
          "team_email": { "type": "string" }
        }
      },
      "outputSchema": {
        "status": { "type": "string" }
      }
    },
    {
      "name": "ClientEmail",
      "type": "output",
      "subtype": "mail-writer",
      "position": [1300, 200],
      "parameters": {
        "to": "{{json.client_email}}",
        "subject": { "type": "string" },
        "body": { "type": "string" }
      },
      "inputSchema": {
        "type": "object",
        "properties": {
          "item": { "type": "string" },
          "problem": { "type": "string" },
          "solution": { "type": "string" },
          "date": { "type": "string" },
          "client_email": { "type": "string" }
        }
      },
      "outputSchema": {
        "status": { "type": "string" }
      }
    }
  ],
  "connections": {
    "DailyTrigger": {
      "main": [[{ "targetNode": "ExcelReader", "inputIndex": 0 }]]
    },
    "ExcelReader": {
      "main": [[{ "targetNode": "SplitInBatches", "inputIndex": 0 }]]
    },
    "SplitInBatches": {
      "main": [
        [
          { "targetNode": "NaverImageAnalyze", "inputIndex": 0 },
          { "targetNode": "NaverTextAnalyze", "inputIndex": 0 }
        ]
      ]
    },
    "NaverImageAnalyze": {
      "main": [[{ "targetNode": "CheckTeamCondition", "inputIndex": 0 }]]
    },
    "CheckTeamCondition": {
      "main": [[{ "targetNode": "MergeData", "inputIndex": 0 }]],
      "sub": [[{ "targetNode": "End Node", "inputIndex": 0 }]]
    },
    "NaverTextAnalyze": {
      "main": [[{ "targetNode": "MergeData", "inputIndex": 0 }]]
    },
    "MergeData": {
      "main": [
        [{ "targetNode": "SaveToDB", "inputIndex": 0 }],
        [{ "targetNode": "TeamEmail", "inputIndex": 0 }],
        [{ "targetNode": "ClientEmail", "inputIndex": 0 }]
      ]
    }
  }
}
